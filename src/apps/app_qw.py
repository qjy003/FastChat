# 标准库导入from typing import Any, Callable, Dict# 应用程序基础类from src.base.app import ChatApplicationfrom src.base.store import Store# 回复模块from src.replys.greeting import GreetingChatModulefrom src.replys.additional_ask import AdditionalAskfrom src.replys.conclude_info import ConcludeInfofrom src.replys.end_conversation import EndConversation# 思考模块from src.thinks.collect_info import CollectInfofrom src.thinks.tmp_collect_info import TmpCollectInfofrom src.thinks.info_confirm import InfoConfirm# 评估模块from src.evaluates.evaluate_reply import EvaluateReply# 存储模块from src.stores.store_for_qw import StoreForQW# 对话应用from src.https.chat_qw import ChatQW# 前端模块from src.fronts.front_qw import FrontQW# 查询模块from src.querys.jd_query import JDQueryclass AppQW(ChatApplication):    """    与询问客户的物流信息的简单聊天应用示例    """    def initialize(self):        """        对话应用服务启动时执行添加特定的模块儿及http接口和交互界面        Returns:        """        # 加载对话回复模块儿        self.add_reply_module(GreetingChatModule(), module_name='greeting')        self.add_reply_module(AdditionalAsk(), module_name='additional_ask')        self.add_reply_module(ConcludeInfo(), module_name='conclude_info')        self.add_reply_module(EndConversation(), module_name='end_conversation')        # 加载推理思考模块儿        self.add_think_module(CollectInfo(), module_name='collect_info')        self.add_think_module(TmpCollectInfo(), module_name='tmp_collect_info')        self.add_think_module(InfoConfirm(model_name='glm-4'),                              module_name='info_confirm',                              white_list=['conclude_info'])        # 加载回复评估模块儿        self.add_evaluate_module(EvaluateReply(), module_name='evaluate_reply')        # 加载知识查询模块儿        self.add_query_module(JDQuery(),                              module_name='jd_knowledge',                              variable_name='last_user_sentence',                              query_field='content_vector',                              result_fields=['content'],                              top_k=3,                              min_score=0.4)        # 加载http接口服务模块儿        self.add_http_interface(ChatQW(), path='/chat', module_name='http服务请求')        # 加载前端交互服务模块儿        self.add_front_interface(FrontQW(), module_name='前端展示')    def set_store_class(self) -> type:        """        指定负责数据及逻辑存储的类类型        Returns: 负责数据及逻辑存储的类类型        """        return StoreForQW    def request_preprocess(self, request_inputs: Dict) -> Callable:        """        请求接收时指定恰当的处理方法来负责执行推理        Args:            request_inputs: 请求数据        Returns:        """        return self.inference    def load_store(self, inference_inputs: Dict, store: Store) -> Store:        """        根据请求数据来载入store对象        Args:            inference_inputs: 调用inference方法的入参参数            store: 待进行数据加载的store对象        Returns:        """        getattr(store, 'set_state')(received_info=inference_inputs['received_info']['data'])        store.conversation_history_str = "\n".join(            [v for v in getattr(store, 'encrypt_conversation')(inference_inputs.get("conversation_history", []))])        store.salesperson_name = inference_inputs.get('robot_name', '王雪凝')        return store    def update_original_chat_stage(self, inference_inputs: Dict) -> str:        """        获取请求数据接收时的对话阶段        Args:            inference_inputs: 调用inference方法的入参参数        Returns:        """        stage = inference_inputs['received_info'].get('stage', 'greeting')        return stage    def gen_think_and_query_inputs(self, store: Store, inference_inputs: Dict) -> Dict:        """        生成执行思考推理、知识查询所需的入参数据        Args:            store: 载入后的store对象            inference_inputs: 调用inference方法的入参参数        Returns:        """        collect_info = getattr(store, 'get_collect_info')()        collect_info_num = getattr(store, 'get_collect_info_num')()        info_check_laws = getattr(store, 'gen_info_check_laws')()        system_info = getattr(store, 'output_customer_info')()        conversation_history = getattr(store, 'conversation_history_str')        salesperson_name = inference_inputs.get('robot_name', '王雪凝')        last_user_sentence = getattr(store, 'retrieve_role_last_reply')(            inference_inputs.get("conversation_history", []))        conclude_info = getattr(store, 'get_conclude_info')()        # 返回各思考推理、知识查询模块所需要的占位符对应数值或入参参数        return {            "collect_info": {"collect_info": collect_info,                             "collect_info_num": collect_info_num,                             "info_check_laws": info_check_laws,                             "system_info": system_info,                             "conversation_history": conversation_history                             },            "tmp_collect_info": {                "collect_info": collect_info,                "collect_info_num": collect_info_num,                "info_check_laws": info_check_laws,                "system_info": system_info,                "conversation_history": conversation_history            },            "info_confirm": {                "conclude_info": conclude_info,                "conversation_history": conversation_history,                "salesperson_name": salesperson_name            },            "jd_knowledge": {                "query_content": last_user_sentence,                "query_field": "content_vector",                "top_k": 3,                "result_fields": ["content"]            }        }    def update_store(self,                     store: Store,                     think_results: Dict,                     query_results: Dict,                     original_chat_stage,                     inference_inputs: Dict) -> Store:        """        根据思考推理和知识查询的结果来更新store对象        Args:            store: store存储对象            think_results: 各模块儿思考推理的结果            query_results: 各知识查询模块儿            original_chat_stage: 请求接收时的对话阶段            inference_inputs: 调用inference方法的入参参数        Returns: 更新后的store对象        """        is_update = getattr(store, 'check_info_update')(think_results.get('collect_info').get('data', {}),                                                        think_results.get('tmp_collect_info').get('data', {}))        store.is_update = is_update        getattr(store, 'update_key_values')(think_results.get('collect_info').get('data', {}))        if original_chat_stage == 'conclude_info':            getattr(store, 'update_info_confirm_result')(info_confirm_result=think_results.get('info_confirm'))        store.knowledge = "\n".join([f"{i},{v}" for i, v in enumerate(query_results.get('jd_knowledge'))])        store.knowledge = store.knowledge if len(store.knowledge) > 0 else '空'        return store    def update_chat_stage(self,                          store: Store,                          think_results: Any,                          query_results: Any,                          original_chat_stage: str,                          inference_inputs: Any):        """        根据store对象、思考推理的结果、知识查询的结果等来更新对话阶段        Args:            store: store存储对象            think_results: 思考推理的结果            query_results: 知识查询的结果            original_chat_stage: 请求接收时的对话阶段            inference_inputs: 调用inference方法的入参参数        Returns: 执行回复的对话阶段        """        if original_chat_stage == 'greeting' and \                getattr(store, 'is_update') and \                getattr(store, 'get_not_received_info_num')() > 0:            return 'additional_ask'        elif original_chat_stage == 'greeting' and \                getattr(store, 'get_not_received_info_num')() <= 0:            return 'conclude_info'        elif original_chat_stage == 'additional_ask' and \                getattr(store, 'get_not_received_info_num')() <= 0:            return 'conclude_info'        elif original_chat_stage == 'conclude_info' and \                getattr(store, 'info_confirm_result') == 2:            return 'end_conversation'        else:            return original_chat_stage    def gen_reply_inputs(self,                         current_chat_stage: str,                         store: Store,                         think_results: Dict,                         query_results: Any,                         original_chat_stage: str,                         inference_inputs: Dict) -> Dict:        """        生成对话回复模块的各占位符对应的取值        Args:            current_chat_stage: 当前指定的对话阶段            store: 存储对象store            think_results: 各思考推理模块执行思考推理的结果            query_results: 各知识查询模块执行知识查询的结果            original_chat_stage: 请求接收时的原始对话阶段            inference_inputs: 调用inference方法的入参参数        Returns: 调用对话回复模块的各占位符对应的取值        """        greeting = getattr(store, 'gen_greeting_reply')(salesperson_name=getattr(store, 'salesperson_name'))        salesperson_name = getattr(store, 'salesperson_name')        conversation_history = getattr(store, 'conversation_history_str') \            if getattr(store, 'conversation_history_str') else '空'        ask_info = getattr(store, 'get_not_received_info')()        n_ask_info = getattr(store, 'get_ask_info')()[1]        conclude_info = getattr(store, 'get_conclude_info')()        newest_reply = getattr(store, 'retrieve_role_last_reply')(inference_inputs.get("conversation_history", []),                                                                  role_name='user')        n_conclude_info = getattr(store, 'get_conclude_info_num')()        reply_question_prompt = getattr(store, 'question_reply_prompt')(getattr(store, 'knowledge') != '空')        return {            'greeting': {                'salesperson_name': salesperson_name,                'greeting': greeting,                'ask_info': ask_info,                'conversation_history': conversation_history,                'knowledge': getattr(store, 'knowledge'),                'question_reply_prompt': reply_question_prompt            },            'additional_ask': {                'ask_info': ask_info,                'salesperson_name': salesperson_name,                'n_ask_info': n_ask_info,                'conversation_history': conversation_history,                'knowledge': getattr(store, 'knowledge'),                'question_reply_prompt': reply_question_prompt            },            'conclude_info': {                'salesperson_name': salesperson_name,                'conclude_info': conclude_info,                'newest_reply': newest_reply,                'n_conclude_info': n_conclude_info,                'conversation_history': conversation_history,                'knowledge': getattr(store, 'knowledge'),                'question_reply_prompt': reply_question_prompt            },            'end_conversation': {                'salesperson_name': salesperson_name,                'newest_reply': newest_reply,                'conversation_history': conversation_history,                'knowledge': getattr(store, 'knowledge'),                'question_reply_prompt': reply_question_prompt            }        }    def gen_evaluate_inputs(self,                            reply_results: Any,                            current_chat_stage: str,                            store: Store,                            think_results: Dict,                            query_results: Dict,                            original_chat_stage: str,                            inference_inputs: Dict                            ) -> Any:        """        生成评估回复结果质量的各模块的占位符对应的取值        Args:            reply_results: 当前指定的对话回复模块儿生成的结果            current_chat_stage: 当前的对话阶段            store: 记忆存储对象            think_results: 各个思考推理模块执行思考推理的结果            query_results: 各个知识查询模块执行知识查询的结果            original_chat_stage: 请求接收时的对话阶段            inference_inputs: 调用inference方法的入参参数        Returns:        """        salesperson_name = getattr(store, 'salesperson_name')        generate_reply = getattr(store, 'encrypt_conversation')([reply_results])[0]        conversation_history = getattr(store, 'conversation_history_str')        return {            'evaluate_reply': {                'salesperson_name': salesperson_name,                'generate_reply': generate_reply,                'conversation_history': conversation_history            }        }    def process_inference_results(self,                                  evaluate_results: Dict,                                  reply_results: Any,                                  current_chat_stage: str,                                  store: Store,                                  think_results: Dict,                                  query_results: Dict,                                  original_chat_stage: str,                                  inference_inputs: Dict):        """        结合各个节点产出的数据生成约定格式的返回数据        Args:            evaluate_results: 对话回复内容的评估结果            reply_results: 当前指定的对话回复模块儿生成的结果            current_chat_stage: 当前的对话阶段            store: 记忆存储对象            think_results: 各个思考推理模块执行思考推理的结果            query_results: 各个知识查询模块执行知识查询的结果            original_chat_stage: 请求接收时的对话阶段            inference_inputs: 调用inference方法的入参参数        Returns:        """        safe_level = evaluate_results.get('evaluate_reply')        return {            'received_info': {                'data': getattr(store, 'get_key_values')(),                'stage': current_chat_stage,                'original_stage': original_chat_stage            },            'answer': getattr(store, 'decrypt_conversation')(reply_results),            'safe_level': safe_level        }